FROM golang:1.21 as build
WORKDIR /image-compressor
COPY go.mod go.sum ./
COPY main.go .

RUN apt-get update && apt-get install -y --no-install-recommends \
    libvips-dev \
    && rm -rf /var/lib/apt/lists/*

# apparently do not need this
# ENV PKG_CONFIG_PATH /usr/lib/x86_64-linux-gnu/pkgconfig
# ENV LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH

# RUN ldconfig

# ENV LD_LIBRARY_PATH /usr/local/lib:$LD_LIBRARY_PATH


# Download and compile libvips from source
# RUN curl -sLO https://github.com/libvips/libvips/releases/download/v8.12.2/vips-8.12.2.tar.gz \
#     && tar -xzf vips-8.12.2.tar.gz \
#     && cd vips-8.12.2 \
#     && ./configure \
#     && make \
#     && make install \
#     && ldconfig

RUN go build -tags lambda.norpc -o main main.go

FROM public.ecr.aws/lambda/provided:al2023

COPY --from=build /usr/lib/x86_64-linux-gnu/* ./
COPY --from=build /image-compressor/main ./main
ENTRYPOINT [ "./main" ]